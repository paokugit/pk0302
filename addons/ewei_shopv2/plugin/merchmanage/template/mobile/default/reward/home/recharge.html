<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>卡路里充值</title>
</head>
<link rel="stylesheet" href="../addons/ewei_shopv2/plugin/merchmanage/static/css/reward/Rechange.css">
<body>
    <div class="rechange_body">
        <!-- header -->
        <div class="rechange-header">
            <div class="rechange-back"><a href="javascript:history.back(-1)"><img src="http://paokucoin.com/img/backgroup/fanhui.png" alt=""></a></div>
            <div class="rechange-tit">卡路里充值</div>
        </div>
        <!-- header -->
        <!-- content -->
        <div class="rechange-content">
            <div class="rechange-content-center">
                <div class="rechange-info-box">
                    <div class="rechange-info-top">
                        <p class="rechange-info-tit">充值金额</p>
                        <div class="rechange-money-box">
                            <div class="money-img"><img src="http://paokucoin.com/img/backgroup/renminbi.png" alt=""></div>
                            <input class="money_ipt" type="text" name=""  placeholder="最小充值10元">
                        </div>
                    </div>
                    <div class="rechange-info-bottom">
                        <div class="choose-money-box">
                            <div class="choose-money-other"></div>
                            <div class="choose-money-text">选择固定金额</div>
                        </div>
                        <div class="type-box">
                            <!-- <li class="type-item"><span class="type-money-num">￥30元</span><span class="money-give">赠送￥200</span></li>
                            <li class="type-item">￥30元</li> -->
                        </div>
                        <div class="rechange-btn-box">
                            <button class="rechange-btn">充值</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- content -->
    </div>
    <!-- 错误提示 -->
    <div id="warning">
        <div class="mask-text"></div>
    </div>
</body>
</html>
<script src="../addons/ewei_shopv2/plugin/merchmanage/static/css/reward/jquery-1.11.3.min.js"></script>
<script type="text/javascript">   
    var itemid=''
    var money='' 
    var message=''
$(window).load(function() { 
    var str1='';
    var typebox=$(".type-box")
    
    $.ajax({
        type: 'POST',
        url:'{php echo mobileUrl('merchmanage/reward/index/purchaseset')}',		
        dataType: "json", 
        success: function(data){
            console.log(data)
            $.each(data.result.set, function(i, item) {
            // console.log(item.id);
            if(item.give > 0){
                str1 += '<li class="type-item" data-id='+item.id+' data-money='+item.money+'>'+'<span class="type-money-num">'+'￥'+data.result.set[i].money+'元'+'</span>'+'<span class="money-give">'+'赠送￥'+data.result.set[i].give+'</span>'+'</li>'
            }else{
                str1 += '<li class="type-item" data-id='+item.id+' data-money='+item.money+'>'+'<span class="type-money-num">'+'￥'+data.result.set[i].money+'元'+'</span>'+'</li>'
            }
            typebox.html(str1)
            });
            
        // 动态插入的html，需要委派事件处理。
        typebox.delegate ('.type-item', 'click', function (){    
        $(this).addClass("active");
		$(this).siblings().removeClass("active");
		// 获取当前点击li 的下标
		let index = $(this).index();
        let dataId = $('.active').attr("data-id");
        let dataMoney = $('.active').attr("data-money");
        itemid= dataId
        money=dataMoney
        // console.log(itemid,money)
        })
            
        } ,
        });


        
}); 
    // 充值的点击事件
    $(".rechange-btn").bind("click",function(){
        if(itemid==''){
            itemid=0
        }else{
            itemid= itemid
        }
        if(money==''){
            money=$(".money_ipt").val()
        }else{
            money= money
        }
        console.log(itemid,money)
        $.ajax({
                type: 'POST',
                url: '{php echo mobileUrl('merchmanage/reward/index/order')}' ,
                data: {
                    "purchase_id":itemid,
                    "merchid":'3'
                } ,
                dataType: "json", 
                success: function(data){
                    console.log(data)
                    message=data.result.message
                    console.log(message)
                    $.ajax({
                    type: 'POST',
                    url: '{php echo mobileUrl('merchmanage/reward/index/order_wx')}' ,
                    data: {
                        "order_sn":message
                    } ,
                    dataType: "json", 
                    success: function(data){
                        console.log(data)
                        
                        if(data.status=="1"){
                            function onBridgeReady(){
                            WeixinJSBridge.invoke(
                            'getBrandWCPayRequest', {
                            "appId":data.result.appId,     //公众号名称，由商户传入     
                            "timeStamp":data.result.timeStamp,         //时间戳，自1970年以来的秒数     
                            "nonceStr":data.result.nonceStr, //随机串     
                            "package":data.result.package,     
                            "signType":"MD5",         //微信签名方式：     
                            "paySign":data.result.paySign//微信签名 
                    },
                    
                    function(res){
                    if(res.err_msg == "get_brand_wcpay_request:ok" ){
                            console.log('ok')
                            $.ajax({
                                type: 'POST',
                                url: '{php echo mobileUrl('merchmanage/reward/index/order_wxback')}' ,
                                data: {
                                    "order_sn":message
                                } ,
                                dataType: "json", 
                                success: function(data){
                                    console.log(ok)
                                    console.log(data)
                                    if(data.status==1){
                                        location.href='{php echo mobileUrl('merchmanage/reward/home/index')}'
                                    }else{
                                       var errMsg=data.result.message
                                        $("#warning").show().delay(1000).hide(300);
                                        $("#warning .mask-text ").text(errMsg);
                                    }
                                }
                            })
                            
                    } 
                }); 
            }
            function callpay()
            {
                if (typeof WeixinJSBridge == "undefined"){
                    if( document.addEventListener ){
                        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                    }else if (document.attachEvent){
                        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                    }
                }else{
                    onBridgeReady();
                }
            }
                
                        }else{
                            var errormsg=data.result.message
                            console.log("error")
                            $("#warning").show().delay(1000).hide(300);
                            $("#warning .mask-text ").text(errormsg);
                        }
                       
                    

                }
            })

                }
            })
    })


</script>